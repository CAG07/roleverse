name: PR Labeler

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  label-by-path:
    name: Label by File Path
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml
          sync-labels: true

  label-by-size:
    name: Label by PR Size
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Label PR Size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: 10
          s_label: 'size/S'
          s_max_size: 50
          m_label: 'size/M'
          m_max_size: 200
          l_label: 'size/L'
          l_max_size: 500
          xl_label: 'size/XL'
          fail_if_xl: false
          message_if_xl: >
            This PR is quite large. Consider breaking it into smaller, focused PRs
            for easier review.

  label-by-content:
    name: Label by PR Content
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Breaking Changes
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });

            const labels = [];
            const title = pr.title.toLowerCase();
            const body = (pr.body || '').toLowerCase();

            // Conventional commit label mapping
            if (title.startsWith('feat')) labels.push('feature');
            if (title.startsWith('fix')) labels.push('bug');
            if (title.startsWith('docs')) labels.push('documentation');
            if (title.startsWith('refactor')) labels.push('refactor');
            if (title.startsWith('test')) labels.push('testing');
            if (title.startsWith('chore')) labels.push('chore');
            if (title.startsWith('ci')) labels.push('ci/cd');
            if (title.includes('!:') || body.includes('breaking change')) labels.push('breaking-change');

            // RoleVerse domain labels
            if (body.includes('mcp') || title.includes('mcp')) labels.push('mcp-server');
            if (body.includes('agent') || title.includes('agent')) labels.push('ai-agents');
            if (body.includes('fantasy grounds') || body.includes('fg')) labels.push('fantasy-grounds');
            if (body.includes('supabase') || body.includes('database') || body.includes('migration')) labels.push('database');

            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: labels,
              });
            }
